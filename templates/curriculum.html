{% extends "base.html" %}

{% block title %}Curriculum | Revision Timetable{% endblock %}

{% block header_title %}Curriculum{% endblock %}

{% block extra_css %}
<style>
    .card-header {
        background: var(--primary-color);
        color: white;
        cursor: default;
        padding: 15px 20px;
    }
    
    .year-title, .module-title {
        background: var(--header-bg);
        padding: 12px 15px;
        margin: 10px -15px;
        cursor: pointer;
        border-left: 4px solid var(--primary-color);
        position: relative;
        color: var(--text-color);
    }
    
    .topic-list {
        margin: 10px 0;
        padding-left: 0;
        list-style: none;
    }
    
    .topic-item {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-left: 3px solid transparent;
        transition: border-color 0.2s ease;
        color: var(--text-color);
    }
    
    .topic-item:hover {
        border-left-color: var(--primary-color);
        background: rgba(67, 97, 238, 0.03);
    }
    
    .topic-title {
        color: var(--primary-color);
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 1.1em;
    }
    
    .topic-content {
        color: var(--text-color);
        padding-left: 0;
        margin-top: 5px;
    }
    
    .collapsible::after {
        content: '\f078';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        position: absolute;
        right: 15px;
        transition: transform 0.3s;
    }
    
    .collapsible.collapsed::after {
        transform: rotate(-90deg);
    }
    
    .collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out;
        padding: 0 15px;
    }
    
    .collapsible-content.expanded {
        max-height: 2000px;
        padding: 15px;
    }
    
    .module-name {
        color: var(--text-color);
        font-size: 0.9em;
        margin-left: 10px;
        opacity: 0.8;
    }
</style>
{% endblock %}

{% block content %}
<div id="content" class="content"></div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize when document is ready
    document.addEventListener('DOMContentLoaded', () => {
        loadCurriculumContent();
    });

    function loadCurriculumContent() {
        fetch('/static/data/curriculum.json')
            .then(response => response.json())
            .then(data => {
                document.getElementById('content').innerHTML = formatCurriculum(data);
                // Add click listeners after content is loaded
                initializeCollapsibles();
            })
            .catch(error => console.error('Error:', error));
    }

    function initializeCollapsibles() {
        document.querySelectorAll('.collapsible').forEach(elem => {
            elem.classList.add('collapsed');
            elem.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleCollapse(this);
            });
        });
    }

    function toggleCollapse(element) {
        element.classList.toggle('collapsed');
        const content = element.nextElementSibling;
        content.classList.toggle('expanded');
    }

    function formatCurriculum(data) {
        let html = '';
        Object.entries(data).forEach(([subjectKey, subject]) => {
            html += `
                <div class="card mb-4">
                    <div class="card-header">
                        ${subject.Title || subjectKey}
                    </div>
                    <div class="card-body">`;

            if (subject.Papers) {
                subject.Papers.forEach(paper => {
                    html += formatPaper(paper);
                });
            } else if (subject.Years) {
                subject.Years.forEach(year => {
                    html += formatYear(year);
                });
            } else if (subject.Modules) {
                subject.Modules.forEach(module => {
                    html += formatModule(module);
                });
            }

            html += `</div></div>`;
        });
        return html;
    }

    function formatYear(year) {
        return `
            <div class="year-title collapsible">
                <i class="fas fa-graduation-cap mr-2"></i> ${year.Title || year.Name}
            </div>
            <div class="collapsible-content">
                ${year.Modules.map(module => formatModule(module)).join('')}
            </div>`;
    }

    function formatModule(module) {
        return `
            <div class="module-title collapsible">
                <i class="fas fa-book mr-2"></i> ${module.Title}
                <span class="module-name">${module.Name || ''}</span>
            </div>
            <div class="collapsible-content">
                ${module.Description ? `<p class="module-description"><em>${module.Description}</em></p>` : ''}
                ${formatTopics(module.Topics)}
            </div>`;
    }

    function formatTopics(topics) {
        if (!topics) return '';
        
        let html = '<div class="topic-list">';
        topics.forEach(topic => {
            if (typeof topic === 'string') {
                html += `
                    <div class="topic-item">
                        <div class="topic-title">
                            <i class="fas fa-lightbulb mr-2"></i> ${topic}
                        </div>
                    </div>`;
            } else {
                html += `
                    <div class="topic-item">
                        <div class="topic-title">
                            <i class="fas fa-lightbulb mr-2"></i> ${topic.Title}
                        </div>
                        ${topic.Content ? `<div class="topic-content">${topic.Content}</div>` : ''}
                    </div>`;
            }
        });
        html += '</div>';
        return html;
    }

    function formatPaper(paper) {
        return `
            <div class="year-title collapsible">
                <i class="fas fa-file-alt mr-2"></i> ${paper.Title}
            </div>
            <div class="collapsible-content">
                ${paper.Topics.map(topic => `
                    <div class="module-title collapsible">
                        <i class="fas fa-lightbulb mr-2"></i> ${topic.Title}
                    </div>
                    <div class="collapsible-content">
                        <div class="topic-list">
                            ${Array.isArray(topic.Content) 
                                ? topic.Content.map(item => `
                                    <div class="topic-item">
                                        <div class="topic-title">
                                            <i class="fas fa-check-circle mr-2"></i> ${item}
                                        </div>
                                    </div>`).join('') 
                                : ''}
                        </div>
                    </div>
                `).join('')}
            </div>`;
    }
</script>
{% endblock %}